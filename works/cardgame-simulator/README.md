# LoveCard – ラブライブ！カードゲーム シミュレーター

## ① プロジェクト概要
友人が始めた「ラブライブ！カードゲーム」のデッキ検証のために作った、1人用カードゲームシミュレーターです。  
本来は紙のカードをプロキシで印刷してシャッフルしながら、「この構築でちゃんと回るか」「ブレードは何枚入れるべきか」といった検証をする必要がありますが、その手間と時間を大きく減らすことを目的にしています。

### 想定ユーザー
- ラブライブ！カードゲームを遊んでいる友人  
- デッキ構築や確率検証に興味はあるが、PCやプログラミングの知識はあまりないプレイヤー  

### 解決したい課題
- プロキシカードの印刷・カット・シャッフルなどの準備コスト  
- 「ドロー」「コスト支払い」「バトンタッチ」「サーチ」など毎ターン繰り返される作業の煩雑さ  
- ブレード枚数や色配分と、ライブ成功確率の関係が直感では分かりにくいこと  

ゲームの進行はできるだけ自動化し、「カード固有効果」だけを手動処理にする設計としました。  
また、**ブレード枚数やハート要求値に対するライブ成功確率を計算する統計機能**を搭載し、紙で回すよりも付加価値を持たせています。

---

## ② 使用技術
- **言語 / ランタイム**  
  - Python 3
- **ライブラリ / フレームワーク**  
  - Pygame：ゲームメイン画面の描画、マウス操作など  
  - Tkinter：統計ウィンドウ表示（別スレッド動作）  
  - PyInstaller：Windows向けEXE生成  
  - PyCryptodome：カードデータのAES復号  
- **データ形式 / 外部サービス**  
  - JSON（カード・デッキ・設定データ）  
  - HTTPアクセス (`urllib`)  
    - **友人が運用するカード画像サーバー**から不足しているカード画像を自動ダウンロード  
      - 誰でも利用可能で、画像更新を「アップデート不要」で反映できる設計  
  - GitHub API  
    - カードリスト更新用の暗号化データを取得し、更新確認と復号を実行  

---

## ③ 工夫した点・実装の特徴

### ● 状態管理の一元化
- `GameState` データクラスに山札・手札・ステージ・控室などすべての状態を集約。
- これにより、どのモジュールからでも現在の状態を正確に参照・更新できる。

### ● 表示・入力・ルールの分離
- `layout_utils.py`：画面レイアウト計算  
- `render.py`：描画処理  
- `events/handlers.py`：操作イベント処理  
- 座標やレイアウトを比率で計算することで、解像度依存を排除。

### ● カード画像・データ更新の自動化
- 不足画像は友人が運用する画像サーバーから取得。  
  → ユーザーが手動で画像を用意する必要がなく、アップデートも不要。  
- カードデータは暗号化されたJSONをGitHubから取得して復号。  
  → データを安全に公開しつつ、ボタン一つで最新カードに対応可能。

### ● 統計ウィンドウと確率計算
- Tkinterウィンドウでブレード枚数・ハート要求を指定し、DP（動的計画法）でライブ成功確率を計算。  
- 山札・ステージ状態を基に確率を即時計算し、ブレード構成の調整指標に利用できる。

### ● ユーザー環境への配慮
- 初回起動時に必要ファイルを自動コピー。  
- 既存デッキを上書きしないようマージ処理を実装。  
- PyInstallerでEXE化し、非開発者でもワンクリックで起動可能。

---

## ④ 技術的な学び・課題解決

### ● PygameとTkinterの共存
- 同一スレッドで動かすとフリーズする問題を、`threading`で並行動作させて解決。  
- 統計ウィンドウを別スレッド化し、ゲーム操作中もリアルタイムに確率確認が可能。

### ● レイアウトの比率化設計
- 解像度による崩れを避けるため、すべてのUI座標を画面比で管理。  
- スロット吸着やドラッグ操作を比率ベースで処理し、再描画時のずれを防止。

### ● DPによる高速確率計算
- 全探索では組み合わせ爆発する問題をDP化して解消。  
- 各色ハート数を状態化し、余剰分をALL/黒ハートとして集約し状態数を削減。

### ● データ更新と暗号化処理
- GitHub APIを使って最新コミット日時を取得し、ローカルとの差分のみ更新。  
- AES-CBC復号を実装し、公開データの安全性と利便性を両立。

### ● **update.py（自動アップデータ）の設計**
- exe化後の更新を考慮し、アプリ本体を直接書き換えずに**外部アップデータ（update.py）**を設計。  
- 構成：
  1. GitHubリポジトリの最新リリース情報を取得  
  2. 新しいビルドのハッシュ値とローカル版を比較  
  3. 差分がある場合のみダウンロード・置換を実行  
  4. 処理完了後に自動で再起動  
- **ビルド済みexeでは自分自身を上書きできない**という制約を回避するため、  
  - update.pyをPyInstallerでビルドした **update.exe** を別プロセスで起動し、  
    実行中のLoveCardを終了 → update.exeが最新ビルドを適用 → 再起動、という流れを実現。  
- 非開発者でも「アップデートボタンを押すだけ」で最新バージョンに更新できる仕組みを構築。

### ● **ウイルス誤検知とその原因分析**
- `update.exe` が自己更新を行う挙動（実行中アプリの終了・自身の書き換え・外部ダウンロード）を含むため、  
  一部のウイルス対策ソフトでマルウェアと誤検知される問題が発生。  
- 実際にWindows Defenderや数種のAVで検証し、  
  **「自己書き換え型の自動アップデート処理」自体が検知の原因**であることを特定。  
- これにより、アップデータを本体と分離し、  
  - ユーザーが手動で起動できる「セミオート更新方式」  
  - 自動更新時は一時ディレクトリで安全に展開し再配置する方式  
  など、より安全で誤検知されにくい更新設計への知見を得られました。  

---

## ⑤ 成果・効果
- 紙のデッキを準備せずにドローやコスト支払い、サーチを自動化。  
- ブレード枚数・色配分を変更して確率を確認でき、構築の検証速度が大幅に向上。  
- カード画像・リスト更新が自動化されたことで、  
  新カード登場時のアップデート作業が不要になり、  
  継続的に最新データでシミュレーション可能に。  
- update.exe による自動更新は一時的にウイルス検知を受けたが、  
  その原因を分析し、**安全で誤検知されにくい更新機構の設計知識を得た**。  
- 友人からは「プロキシを作るより早く試せて便利」「更新もワンクリックで終わる」と高評価。  

---

© 2025 LoveCard Project  
Author: （あなたの名前またはハンドル）
