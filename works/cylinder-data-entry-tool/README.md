# Excel VBA シリンダーデータ登録・検索ツール

## 概要

社内で運用しているシリンダー関連データを  
- 「Excel 直打ち＋備考欄に情報を詰め込む」  
- 「同じ内容を何度も手入力する」  

といった状態から脱却させるために作成した、  
**Excel VBA 製のデータ登録・検索ツール（ユーザーフォーム）** です。

- 「受注データ」シートと「シリンダーデータ」シートを元に  
  - **シリンダー登録フォーム（form_シリンダー登録）**  
  - **落版検索フォーム（form_落版検索）**  
  を用意し、UI 操作だけでデータベース的に扱えるようにしました。
- 職場で長期利用することを前提に、  
  **「シートを多少いじられても壊れにくい」構造** と  
  **「マウス操作を前提とした自然な UI」** を重視して設計しています。

---

## 工夫したポイント / 技術的な特徴

### 1. シート構造変更に強い「見出し名ベース」のマッピング

列番号を固定せず、**ヘッダー文字列から対象列を検索するヘルパー**を利用しています。

- `FindHeaderColumn` でヘッダー名を検索  
- `MapToTextBox` により「ヘッダー名 → TextBox 名」をマッピング  
- 列構成が変わってもヘッダーさえ同じなら動作可能

**効果:**  
シート構造変更によるバグを最小化し、長期運用でも壊れにくい設計。

---

### 2. 入力値のバリデーションと標準化を共通化

フォーム入力の検証・整形を `M_InputUtils` に集約。

- `KeyFilter`: 数字や記号入力の制限  
- `NormalizeDecimalOnExit`: 小数点の統一  
- `ZeroPadOnExitCmb`: シリンダー番号をゼロ埋め  
- `NormalizeDigits`: 全角→半角変換

**効果:**  
データ形式の揺れを UI 側で吸収し、登録データを常に統一。

---

### 3. 受注データからの自動反映と色ごとの連動更新

受注データからフォームへ自動反映する仕組みを実装。

- 品目番号から該当行を検索  
- シリンダー番号は 0〜9 色分自動セット  
- `OnCylinderComboChange` により色名・ベタ巾・製版日も連動更新

**効果:**  
受注情報の再入力を不要にし、ミス防止と入力効率を大幅改善。

---

### 4. シリンダーデータのマスタ化と複数候補選択 UI

「シリンダーデータ」シートをマスタ化し、ComboBox 候補として活用。

- `PopulateCylinderCombos` で一意キーを生成  
- 重複時は `ChooseRowFromCandidates` で候補一覧を提示して選択

**効果:**  
マスタ選択運用でデータの一貫性を保ちつつ、重複も現実的に処理。

---

### 5. 「反映モード」による半自動入力機能

フォームに「反映モード」を実装。

- `HandleCylinderReflectMode` により品目＋色目から自動入力  
- モード状態はステータスバーとポインタ変更で明示  
- 「反映終了」で通常モードに復帰

**効果:**  
複数色のシリンダー情報をクリックだけで一括反映可能。

---

### 6. マウスホイール対応（Win32 API フック）

標準では動作しない UserForm のマウスホイールを、  
**Win32 API (`SetWindowsHookEx`)** を利用して実現。

- `M_MouseWheelHook`: 低レベルフックでスクロール処理  
- `M_WheelBridge`: フォームとの連携管理  
- 64bit / 32bit 両対応 (`#If VBA7 Then`)

**効果:**  
マウス操作に自然に対応し、既製品レベルの操作感を実現。

---

### 7. 解像度対応のフォームスケーリング

`M_FormScale` により、フォーム最大化時に  
コントロール位置・サイズ・フォントを自動スケーリング。

- 初期状態を `Dictionary` に保持  
- 拡大率を計算して位置・フォントサイズを再設定

**効果:**  
異なる解像度や老眼対策にも対応した柔軟な UI。

---

### 8. 検索結果を安全に外出しする仕組み

検索結果は一時シートに書き出し、ListBox などに表示。

- 定数 `SEARCH_RESULT_WORKSHEET_NAME` で管理  
- 元データは常に読み取り専用

**効果:**  
検索結果を自由に確認・加工でき、元データの安全性を確保。

---

### 9. 壊れにくいエラーハンドリングと防御的設計

- `On Error Resume Next`＋オブジェクト存在確認  
- `HasControl` で UI 要素を動的に検出  
- 範囲外アクセスを事前チェック  
- 全モジュール `Option Explicit`

**効果:**  
環境差異や誤操作にも強く、業務が止まらない堅牢設計。

---

## まとめ

このツールは Excel 上で

- 入力標準化  
- マスタ参照・検索機能  
- UI 改善（マウスホイール、反映モード）  
- 64bit 環境対応  
- シート構造変更耐性  

をすべて実現した **業務改善特化型 VBA プロジェクト** です。

> 「誰でも使える」「壊れにくい」「現場の運用を止めない」  
> ― そのバランスを重視して設計した、実務導入可能な Excel VBA システムです。
