# Discord 連帯責任リマインダーボット

## ① プロジェクト概要

### 目的・課題
ADHD 傾向のある友人が「リマインダーを登録しても通知を無視してしまう」課題を解決するために開発しました。通知を無視すると Discord サーバーのランダムなメンバーにメンションが飛ぶかもしれないという **軽い社会的プレッシャーを行動促進の動機づけにする** 仕組みを実装しています。

### 想定ユーザー
- ADHD 傾向や自己管理が苦手な人
- Discord を日常的に使うコミュニティ・友人グループ
- 行動習慣をゲーム感覚で改善したい人

Google Cloud の無料枠で永続稼働できる構成とし、個人や小規模サーバーでも導入しやすいよう設計しています。

---

## ② 使用技術

| 区分 | 使用技術 |
|------|------------|
| 言語 | JavaScript (Node.js) |
| フレームワーク | Discord.js v14 |
| インフラ | Google Cloud Run / Cloud Scheduler |
| データベース | Google Firestore |
| 日時処理 | Luxon（タイムゾーン対応） |
| その他 | Discord Interactions API / Webhook Verification |

---

## ③ 工夫した点・実装の特徴

### ● 「連帯責任」を仕組みに落とし込む設計
- リマインダーをスヌーズし続けると、**サーバー内のランダムメンバーにメンション**が飛ぶ。
- 本人・Bot・除外設定ユーザーはメンション候補から除外。
- 完了ボタンは「本人またはメンションされた保証人のみ」が押せるよう制限。

### ● 無料枠での永続稼働を意識した構成
- Cloud Run は完全な **HTTP トリガーベース構成** で常駐コストなし。
- Firestore アクセスをキャッシュ・バッチ処理で削減。
- Discord API 呼び出しも 1000 件単位のページングとキャッシュで最適化。

### ● 多言語・タイムゾーン対応
- 文言を `MESSAGES` 辞書に分離し、日本語／英語を自動切替。
- タイムゾーンに応じた quiet hours（通知禁止時間帯）処理を実装。

### ● ADHD 向け UX 設計
- `/menu` からボタン操作で登録できるモーダルフォームを提供。
- 入力項目を最小限にし、日時は自動補完＋フォーマット補正。
- 重複登録を防ぐ `content_key` チェック機能。

### ● 拡張性を見越した構造
- サーバー設定・個人設定を GUI で操作可能にし、将来的な多言語化やカレンダー連携にも対応可能。
- 統計データ（完了数・スヌーズ数）を月次で Firestore に保存し、ランキング機能などに拡張しやすい。

---

## ④ 技術的な学び・課題解決

### 課題1：Cloud Run の無料枠で永続稼働
- 常駐プロセスが使えないため、Discord のイベント駆動処理を Cloud Run に分割。
- **Webhook + Cron バッチ** によるステートレス構成で解決。

### 課題2：Firestore 読み込みコストの最適化
- 初期はユーザー設定を全件読み出していたが、コストが高すぎた。
- バッチ単位で 25 件ずつ取得し、キャッシュ化して改善。

### 課題3：タイムゾーン・quiet hours の扱い
- 通知時間が UTC とローカルでずれる問題を確認。
- Luxon による IANA タイムゾーン変換で統一。
- ローカル時刻ベースで静音時間を判定できるように修正。

### 課題4：Discord 署名検証とインタラクション処理
- Webhook の署名認証を実装 (`verifyKeyMiddleware`)。
- Interaction Type (1〜5) ごとにルーティングを整理し、Bot の反応遅延を削減。

---

## ⑤ 成果・効果（追記用）

実際の効果・フィードバック・利用実績を追記してください。例：
- 「実際に友人が〇〇を改善できた」
- 「稼働コストが〇円以下に収まった」
- 「導入後に〇〇％行動率向上」など
